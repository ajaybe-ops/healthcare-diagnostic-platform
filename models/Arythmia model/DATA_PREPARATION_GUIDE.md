# Data Preparation Guide

This guide explains how to set up the `processed/` folder with the required dataset files for training the arrhythmia classification model.

## Folder Structure

```
Arythmia model/
├── processed/              # ← Created automatically
│   ├── X.npy              # ← ECG signals (required)
│   ├── y.npy              # ← Labels (required)
│   ├── record_ids.npy     # ← Patient IDs (required)
│   ├── train_idx.npy      # ← Generated by split.py
│   ├── val_idx.npy        # ← Generated by split.py
│   ├── test_idx.npy       # ← Generated by split.py
│   ├── dataset_schema.json # ← Schema definition (auto-copied)
│   └── README.md          # ← Documentation
├── setup_processed_folder.py  # Setup script
├── prepare_data.py        # Sample data generator
├── split.py               # Creates train/val/test splits
└── train_pytorch.py       # Training script
```

## Quick Start (Sample Data)

If you want to test the pipeline quickly with sample data:

### Step 1: Setup Folder
```bash
python setup_processed_folder.py
```

### Step 2: Generate Sample Data
```bash
python prepare_data.py [num_beats] [num_patients]
```

Example:
```bash
python prepare_data.py 1000 50
```

This creates:
- `X.npy` - 1000 sample ECG beats (360 samples each)
- `y.npy` - Class labels (0-6)
- `record_ids.npy` - 50 unique patient IDs

### Step 3: Create Train/Val/Test Splits
```bash
python split.py
```

This creates:
- `train_idx.npy` - Training set indices (70%)
- `val_idx.npy` - Validation set indices (15%)
- `test_idx.npy` - Test set indices (15%)

### Step 4: Train Model
```bash
python train_pytorch.py
```

## Using Real Data

If you have real ECG data, follow these steps:

### 1. Preprocess Your Raw Data

Convert your raw ECG data (CSV, MAT, etc.) into the required format:

**Requirements:**
- Extract ECG beats (exactly 360 samples per beat)
- Assign arrhythmia class labels (0-6)
- Track patient/record IDs for each beat

**Data Format:**
```python
import numpy as np

# After preprocessing your raw data
X = np.array([...], dtype=np.float32)  # Shape: (num_beats, 360)
y = np.array([...], dtype=np.int64)    # Shape: (num_beats,)
record_ids = np.array([...], dtype=np.int64)  # Shape: (num_beats,)
```

### 2. Save to processed/ Folder

```python
from pathlib import Path

DATA_DIR = Path("processed")
DATA_DIR.mkdir(parents=True, exist_ok=True)

np.save(DATA_DIR / "X.npy", X)
np.save(DATA_DIR / "y.npy", y)
np.save(DATA_DIR / "record_ids.npy", record_ids)
```

### 3. Validate Data

Check that your data matches the schema:

```bash
python schema.py
```

This verifies:
- File existence
- Shape compatibility (X must be (N, 360))
- Data types (float32 for X, int64 for y)
- Label encoding (0-6 only)

### 4. Create Splits

```bash
python split.py
```

This performs patient-wise splitting to avoid data leakage.

### 5. Train Model

```bash
python train_pytorch.py
```

## File Specifications

### X.npy
- **Shape**: `(num_beats, 360)`
- **Dtype**: `float32`
- **Description**: Each row is a single ECG beat with 360 time samples
- **Preprocessing**: Should be normalized (zero mean, unit variance recommended)

### y.npy
- **Shape**: `(num_beats,)`
- **Dtype**: `int64`
- **Values**: 0, 1, 2, 3, 4, 5, or 6
- **Label mapping**:
  - 0: Normal
  - 1: Left bundle branch block
  - 2: Right bundle branch block
  - 3: Atrial premature
  - 4: Premature ventricular
  - 5: Fusion of ventricular and normal
  - 6: Nodal escape

### record_ids.npy
- **Shape**: `(num_beats,)`
- **Dtype**: `int64`
- **Description**: Patient or record ID for each beat
- **Purpose**: Used for patient-wise splitting (no data leakage)

## Troubleshooting

### Error: "Missing required file: X.npy"
- **Solution**: Create X.npy, y.npy, and record_ids.npy in the processed/ folder
- Use `prepare_data.py` for sample data, or preprocess your real data

### Error: "X, y, record_ids lengths do not match"
- **Solution**: Ensure all three arrays have the same length (same number of beats)

### Error: "Patient leakage detected"
- **Solution**: `split.py` ensures no patient appears in multiple splits. Check your record_ids.npy

### Error: "X shape mismatch"
- **Solution**: Each ECG beat must have exactly 360 samples. Check your preprocessing.

## Next Steps

After setting up the data:
1. ✅ Run `python split.py` to create train/val/test splits
2. ✅ Run `python train_pytorch.py` to train the model
3. ✅ Run `python app.py` (after training) to use the Streamlit interface

## Scripts Reference

| Script | Purpose |
|--------|---------|
| `setup_processed_folder.py` | Creates processed/ folder and copies schema |
| `prepare_data.py` | Generates sample dataset for testing |
| `split.py` | Creates patient-wise train/val/test splits |
| `schema.py` | Validates dataset files against schema |
| `train_pytorch.py` | Trains the PyTorch model |
| `validation.py` | Validates preprocessed data quality |

